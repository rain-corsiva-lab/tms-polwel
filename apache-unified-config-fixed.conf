<VirtualHost *:80>
    ServerAdmin webmaster@example.com
    DocumentRoot "/www/wwwroot/polwelpdms/dist"
    ServerName polwel-pdms.customized3.corsivalab.xyz
    ErrorLog "/www/wwwlogs/polwel-pdms.customized3.corsivalab.xyz-error_log"
    CustomLog "/www/wwwlogs/polwel-pdms.customized3.corsivalab.xyz-access_log" combined

    # Enable Apache modules
    LoadModule rewrite_module modules/mod_rewrite.so
    LoadModule proxy_module modules/mod_proxy.so
    LoadModule proxy_http_module modules/mod_proxy_http.so
    LoadModule headers_module modules/mod_headers.so

    # API Proxy Configuration - Route /api requests to Node.js backend
    ProxyPreserveHost On
    ProxyPass /api/ http://localhost:3001/api/
    ProxyPassReverse /api/ http://localhost:3001/api/

    # Health check endpoint
    ProxyPass /health http://localhost:3001/health
    ProxyPassReverse /health http://localhost:3001/health

    # CORS Headers for API requests
    <LocationMatch "^/api/">
        Header always set Access-Control-Allow-Origin "*"
        Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
        Header always set Access-Control-Allow-Credentials "true"
    </LocationMatch>

    # Handle preflight OPTIONS requests for API
    RewriteEngine On
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteCond %{REQUEST_URI} ^/api/
    RewriteRule ^(.*)$ $1 [R=200,L]

    # Frontend Static Files Configuration
    <Directory "/www/wwwroot/polwelpdms/dist">
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        DirectoryIndex index.html

        # Enable compression
        SetOutputFilter DEFLATE
        
        # Cache static assets
        <IfModule mod_expires.c>
            ExpiresActive on
            ExpiresByType text/css "access plus 1 year"
            ExpiresByType application/javascript "access plus 1 year"
            ExpiresByType image/png "access plus 1 year"
            ExpiresByType image/jpg "access plus 1 year"
            ExpiresByType image/jpeg "access plus 1 year"
            ExpiresByType image/gif "access plus 1 year"
            ExpiresByType image/svg+xml "access plus 1 year"
        </IfModule>
    </Directory>

    # SPA Routing - All non-file, non-API requests go to index.html
    RewriteEngine On
    # Don't rewrite files or directories that exist
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    # Don't rewrite API calls
    RewriteCond %{REQUEST_URI} !^/api/
    RewriteCond %{REQUEST_URI} !^/health
    # Rewrite everything else to index.html
    RewriteRule . /index.html [L]

    #DENY FILES
    <Files ~ (\.user.ini|\.htaccess|\.git|\.env|\.svn|\.project|LICENSE|README.md)$>
       Order allow,deny
       Deny from all
    </Files>
</VirtualHost>

<VirtualHost *:443>
    ServerAdmin webmaster@example.com
    DocumentRoot "/www/wwwroot/polwelpdms/dist/"
    ServerName polwel-pdms.customized3.corsivalab.xyz
    ErrorLog "/www/wwwlogs/polwel-pdms.customized3.corsivalab.xyz-error_log"
    CustomLog "/www/wwwlogs/polwel-pdms.customized3.corsivalab.xyz-access_log" combined

    # SSL Configuration
    SSLEngine On
    SSLCertificateFile /www/server/panel/vhost/cert/polwel-pdms.customized3.corsivalab.xyz/fullchain.pem
    SSLCertificateKeyFile /www/server/panel/vhost/cert/polwel-pdms.customized3.corsivalab.xyz/privkey.pem
    SSLCipherSuite EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5:ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP:+eNULL
    SSLProtocol All -SSLv2 -SSLv3 -TLSv1
    SSLHonorCipherOrder On

    # Enable Apache modules
    LoadModule rewrite_module modules/mod_rewrite.so
    LoadModule proxy_module modules/mod_proxy.so
    LoadModule proxy_http_module modules/mod_proxy_http.so
    LoadModule headers_module modules/mod_headers.so

    # API Proxy Configuration - Route /api requests to Node.js backend
    ProxyPreserveHost On
    ProxyPass /api/ http://localhost:3001/api/
    ProxyPassReverse /api/ http://localhost:3001/api/

    # Health check endpoint
    ProxyPass /health http://localhost:3001/health
    ProxyPassReverse /health http://localhost:3001/health

    # CORS Headers for API requests
    <LocationMatch "^/api/">
        Header always set Access-Control-Allow-Origin "https://polwel-pdms.customized3.corsivalab.xyz"
        Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
        Header always set Access-Control-Allow-Credentials "true"
    </LocationMatch>

    # Handle preflight OPTIONS requests for API
    RewriteEngine On
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteCond %{REQUEST_URI} ^/api/
    RewriteRule ^(.*)$ $1 [R=200,L]

    # Frontend Static Files Configuration
    <Directory "/www/wwwroot/polwelpdms/dist/">
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        DirectoryIndex index.html

        # Enable compression
        SetOutputFilter DEFLATE
        
        # Cache static assets
        <IfModule mod_expires.c>
            ExpiresActive on
            ExpiresByType text/css "access plus 1 year"
            ExpiresByType application/javascript "access plus 1 year"
            ExpiresByType image/png "access plus 1 year"
            ExpiresByType image/jpg "access plus 1 year"
            ExpiresByType image/jpeg "access plus 1 year"
            ExpiresByType image/gif "access plus 1 year"
            ExpiresByType image/svg+xml "access plus 1 year"
        </IfModule>
    </Directory>

    # SPA Routing - All non-file, non-API requests go to index.html
    RewriteEngine On
    # Don't rewrite files or directories that exist
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    # Don't rewrite API calls
    RewriteCond %{REQUEST_URI} !^/api/
    RewriteCond %{REQUEST_URI} !^/health
    # Rewrite everything else to index.html
    RewriteRule . /index.html [L]

    #DENY FILES
    <Files ~ (\.user.ini|\.htaccess|\.git|\.env|\.svn|\.project|LICENSE|README.md)$>
       Order allow,deny
       Deny from all
    </Files>
</VirtualHost>
