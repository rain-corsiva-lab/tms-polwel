<VirtualHost *:80>
    ServerName polwel-pdms.customized3.corsivalab.xyz
    DocumentRoot /www/wwwroot/polwelpdms/dist
    
    # Enable rewrite engine
    RewriteEngine On
    
    # API Proxy Rules - Handle /api requests first
    RewriteCond %{REQUEST_URI} ^/api/(.*)$
    RewriteRule ^/api/(.*)$ http://localhost:3001/api/$1 [P,L]
    
    # Health check endpoint
    RewriteCond %{REQUEST_URI} ^/health$
    RewriteRule ^/health$ http://localhost:3001/health [P,L]
    
    # Serve static files directly
    <Directory "/www/wwwroot/polwelpdms/dist">
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Enable compression
        <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE text/plain
            AddOutputFilterByType DEFLATE text/html
            AddOutputFilterByType DEFLATE text/xml
            AddOutputFilterByType DEFLATE text/css
            AddOutputFilterByType DEFLATE application/xml
            AddOutputFilterByType DEFLATE application/xhtml+xml
            AddOutputFilterByType DEFLATE application/rss+xml
            AddOutputFilterByType DEFLATE application/javascript
            AddOutputFilterByType DEFLATE application/x-javascript
            AddOutputFilterByType DEFLATE application/json
        </IfModule>
        
        # Cache static assets
        <IfModule mod_expires.c>
            ExpiresActive on
            ExpiresByType text/css "access plus 1 year"
            ExpiresByType application/javascript "access plus 1 year"
            ExpiresByType image/png "access plus 1 year"
            ExpiresByType image/jpg "access plus 1 year"
            ExpiresByType image/jpeg "access plus 1 year"
            ExpiresByType image/gif "access plus 1 year"
            ExpiresByType image/svg+xml "access plus 1 year"
            ExpiresByType application/json "access plus 0 seconds"
        </IfModule>
    </Directory>
    
    # SPA Fallback - All non-file, non-API requests go to index.html
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} !^/api/
    RewriteCond %{REQUEST_URI} !^/health$
    RewriteRule . /index.html [L]
    
    # Proxy configuration for API requests
    ProxyPreserveHost On
    ProxyTimeout 300
    
    # Let backend handle CORS - don't add duplicate headers
    # CORS is configured in the Node.js backend
    
    # Security headers (non-CORS)
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Logs
    ErrorLog /www/wwwlogs/polwelpdms_error.log
    CustomLog /www/wwwlogs/polwelpdms_access.log combined
</VirtualHost>
